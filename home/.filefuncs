#!/bin/bash
# (c) 2025 Anirudh Acharya
# Helper functions for file operations

# Guard variable to ensure sourcing only once
if [ -n "${SOURCED_FILEFUNCS}" ]; then
  return 0 # Exit the script if already sourced
fi

# Set the guard variable
SOURCED_FILEFUNCS=1

source "${HOME}/.helperfuncs"

debuglog "File functions sourced"

# Function to safely backup (if exists) and install files
install_file() {
  local source_file="$1"
  local dest_file="$2"
  local description="$3"

  # Check if source file exists
  if [[ ! -f "$source_file" ]]; then
    error "Warning: Source file $source_file does not exist, skipping $description"
    return 1
  fi

  # Backup existing file if it exists
  if [[ -e "$dest_file" ]]; then
    info "Backing up existing $description: $dest_file"
    sudo cp -f "$dest_file" "${dest_file}.bak" || {
      error "Error: Failed to backup $dest_file"
      return 1
    }
  fi

  info "Installing $description: $source_file -> $dest_file"
  sudo cp -f "$source_file" "$dest_file" || {
    error "Error: Failed to install $description"
    return 1
  }

  info "Successfully installed $description"
  return 0
}

# Function to add entry to file if not present
append_entry_to_file() {
  local entry="$1"
  local file="$2"
  local description="$3"

  if grep -Fq "$entry" "$file" 2>/dev/null; then
    warn "$description already exists in $file"
  else
    info "Adding $description to $file"
    echo "# Adding $description" | sudo tee -a "$file"
    echo "$entry" | sudo tee -a "$file"
  fi
}

# Generic function to backup existing files or directories
# that are system level and need sudo
backup_system_items() {
  local type="$1"
  local items_array=("${!2}")

  info "Backing up existing $type items..."

  for item in "${items_array[@]}"; do
    if [[ "$type" == "file" && -e "$item" ]]; then
      sudo cp -rf "$item" "${item}.bak"
      info "Backed up file: $item"
    elif [[ "$type" == "dir" && -d "$item" ]]; then
      sudo mv "$item" "${item}.bak"
      info "Backed up directory: $item"
    fi
  done
}


# Generic function to backup existing files or directories that don't need sudo
backup_local_items() {
  local type="$1"
  local items_array=("${!2}")

  info "Backing up existing $type items..."

  for item in "${items_array[@]}"; do
    if [[ "$type" == "file" && -e "$item" ]]; then
      cp -rf "$item" "${item}.bak"
      info "Backed up file: $item"
    elif [[ "$type" == "dir" && -d "$item" ]]; then
      mv "$item" "${item}.bak"
      info "Backed up directory: $item"
    fi
  done
}


# Generic function to create repository file
create_linux_repo_file() {
  local repo_file="$1"
  local repo_content="$2"
  local os_type="$3"

  if [[ ! -e "$repo_file" ]]; then
    info "Creating repository file: $repo_file"
    if [[ "$os_type" == "debian" ]]; then
      # For Debian/Ubuntu, use add-apt-repository
      echo "$repo_content" | sudo add-apt-repository -y
    else
      # For Fedora/RHEL, create repo file
      echo -e "$repo_content" | sudo tee "$repo_file" >/dev/null
    fi
  else
    info "Repository file already exists: $repo_file"
  fi
}